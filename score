#!/usr/bin/env python3
# SPDX-FileCopyrightText: 2025 Keito Tadano
# SPDX-License-Identifier: GPL-3.0-only

import sys
import requests

API_KEY = "2c4165142758434abcfab08ee6203d49"
BASE = "https://api.football-data.org/v4"
HEADERS = {"X-Auth-Token": API_KEY}

ENGLISH_NAMES = {
    "Athletic Club": "Athletic Bilbao",
    "Club Atlético de Madrid": "Atletico Madrid",
    "CA Osasuna": "Osasuna",
    "RCD Espanyol de Barcelona": "Espanyol",
    "FC Barcelona": "Barcelona",
    "Getafe CF": "Getafe",
    "Real Madrid CF": "Real Madrid",
    "Rayo Vallecano de Madrid": "Rayo Vallecano",
    "Levante UD": "Levante",
    "RCD Mallorca": "Mallorca",
    "Real Betis Balompié": "Real Betis",
    "Real Sociedad de Fútbol": "Real Sociedad",
    "Villarreal CF": "Villarreal",
    "Valencia CF": "Valencia",
    "Deportivo Alavés": "Alaves",
    "Elche CF": "Elche",
    "Girona FC": "Girona",
    "RC Celta de Vigo": "Celta Vigo",
    "Sevilla FC": "Sevilla",
    "Real Oviedo": "Real Oviedo"
}

def load_laliga_teams():
    url = f"{BASE}/competitions/PD/teams"
    r = requests.get(url, headers=HEADERS)
    data = r.json()
    teams = data.get("teams", [])
    result = {}
    for t in teams:
        es = t["name"]
        en = ENGLISH_NAMES.get(es, es)
        result[en.lower()] = {"id": t["id"], "name_en": en}
    return result

def get_latest_finished_match(team_id):
    url = f"{BASE}/teams/{team_id}/matches?limit=50"
    r = requests.get(url, headers=HEADERS)
    matches = r.json().get("matches", [])
    matches = sorted(matches, key=lambda x: x["utcDate"], reverse=True)
    for m in matches:
        if m["status"] == "FINISHED":
            return m
    return None

def main():
    line = sys.stdin.readline()

    if line == "" or line == "\n":
        print('使い方: echo "<チーム名>" | score')
        sys.exit(1)

    input_name = line.rstrip("\n")

    if input_name.strip() == "":
        print("入力したチーム名が見つかりません")
        teams = load_laliga_teams()
        for name in sorted(teams.keys()):
            print(teams[name]["name_en"])
        sys.exit(0)

    key = input_name.lower()
    teams = load_laliga_teams()

    if key not in teams:
        print("入力したチーム名が見つかりません")
        for name in sorted(teams.keys()):
            print(teams[name]["name_en"])
        sys.exit(0)

    team = teams[key]
    match = get_latest_finished_match(team["id"])

    if not match:
        print("データがありません")
        sys.exit(0)

    date = match["utcDate"]
    home = ENGLISH_NAMES.get(match["homeTeam"]["name"], match["homeTeam"]["name"])
    away = ENGLISH_NAMES.get(match["awayTeam"]["name"], match["awayTeam"]["name"])
    score = match["score"]["fullTime"]
    h, a = score["home"], score["away"]

    if home.lower() == team["name_en"].lower():
        ts, os_ = h, a
    else:
        ts, os_ = a, h

    if ts > os_:
        result = "WIN"
    elif ts < os_:
        result = "LOSE"
    else:
        result = "DRAW"

    print(date)
    print(away if home == team["name_en"] else home)
    print(f"{result} {h}-{a}")

if __name__ == "__main__":
    main()

